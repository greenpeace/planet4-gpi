FROM gcr.io/planet-4-151612/wordpress:${APP_VERSION}

LABEL authors="Raymond Walker <raymond.walker@greenpeace.org>"

WORKDIR /app

ENV WP_SET_OPTIONS_ON_BOOT=false

RUN rm -fr "${SOURCE_PATH}" && \
    git clone "${GIT_SOURCE}" "${SOURCE_PATH}" && \
    cd "${SOURCE_PATH}" && \
    git checkout "${GIT_REF}"

COPY . /app/

WORKDIR /app/source

RUN groupadd -r -g "${APP_GID}" "${APP_GROUP}" && \
    useradd -r -s /usr/sbin/nologin -u ${APP_UID} -g ${APP_GROUP} ${APP_USER} && \
    composer config extra.merge-plugin.require "composer-local.json" && \
    composer update && \
    composer install --no-interaction
